<html>
	<head>
		<script src=https://teikn-js.googlecode.com/svn-history/r23/trunk/libraries/kinetic-v3.6.0.js></script>
		<script>
			//drawing layer for shapes, needs to be added to stage to get rendered
			var shapesLayer = new Kinetic.Layer();
			var groundLine = [];
			var gameWidth = 300;
			var gameHeight = 300;
			var groundCoords = [gameWidth];
			var cannonX = 20;
			
			function calcDistance(vel, ang, gra) {
				var dis = (Math.pow(vel, 2) * Math.sin(2 * ang)) / g;
				return dis;
			}
			
			function calcTimeOfFlight(vel, ang, gra, dis) {
				var tim = dis / (vel * Math.cos(ang));
				return tim;
			}
			
			function heightAtX(origY, x, ang, gra, vel) {
				var y = origY + (x * Math.tan(ang)) - ((gra * Math.pow(x, 2)) / (2 * Math.pow(vel * Math.cos(deg), 2)));
				return y;
			}
			
			function velocityAtX(vel, gra, x, deg) {
				var vel = Math.sqrt(Math.pow(vel, 2) - (2 * gra * x * Math.tan(deg)) + Math.pow((gra * x) / (vel * Math.cos(ang)), 2));
				return vel;
			}
			
			function shoot(angle, power, context) {
				var origPoint = Math.pow((cannonX - power) / 10, 2);
			
				for (x = cannonX; x < gameWidth; x++) {
					context.beginPath();
					context.arc(x, groundCoords[cannonX] + Math.pow((x - power) / 10, 2) - origPoint, 2, 0, 2 * Math.PI, false);
					context.fillStyle = 'red';
					context.fill();
					context.lineWidth = 1;
					context.strokeStyle = 'red';
					context.stroke();
				}
			}
			
			function placeCannon(context) {
				for (y = gameHeight - 1; y >= 0; y--) {
					var pxl = context.getImageData(cannonX, y, 1, 1).data;
					if (pxl[3] == 0) {
						groundCoords[cannonX] = y;
						break;
					}
				}
								
				context.beginPath();
				context.rect(cannonX - 5, groundCoords[cannonX] - 5, 10, 10);
				context.fillStyle = 'green';
				context.fill();
				context.closePath();
				context.lineWidth = 1;
				context.strokeStyle = 'green';
				context.stroke();
				
				shoot(30, 10, context);
			}
			
			function NewGame() {
				//hide settings input once the game begins
				document.getElementById("settings").style.display = 'none';
				
				var stage = new Kinetic.Stage("container", gameWidth, gameHeight);
				var e = document.getElementById("container");
				
				e.style.width = gameWidth;
				e.style.height = gameHeight;

				//add some stuff to canvas
				(function(){
					groundLine[0] = new Kinetic.Shape(function(){
						var canvas = this.getCanvas();
						var context = this.getContext();  

						var groundSumY = 0;
						var groundAvgY = 0
				
						for (a = 20; a < 100; a += 20) {
							context.beginPath();
							context.moveTo(0, gameHeight);
							for (x = 0; x <= gameWidth; x += a) {
								var y = 200 + Math.floor(Math.random() * 90);
								context.lineTo(x, y);
							}
							context.lineTo(gameWidth, gameHeight);
							context.closePath();
		
							context.lineWidth = 1;
							context.strokeStyle = "gray";
							context.fillStyle = "gray";
							context.fill();
							context.stroke();
						}
						for (x = 0; x < gameWidth; x++) {
							for (y = gameHeight - 1; y >= 0; y--) {
								var pxl = context.getImageData(x, y, 1, 1).data;
								if (pxl[3] == 0) {
									groundCoords[x] = y;
									groundSumY += y;
									break;
								}
							}
						}
						groundAvgY = groundSumY / gameWidth;
				
						context.clearRect(0, 0, canvas.width, canvas.height);
				
						context.beginPath();
						context.moveTo(0, gameHeight);
						for (x = 0; x <= gameWidth; x++) {
							var y = groundAvgY + (groundCoords[x] - groundAvgY) * (groundCoords[x] / (3 * groundAvgY));
							groundCoords[x] = y;
							context.lineTo(x, y);
						}
						context.lineTo(gameWidth, gameHeight);
						context.closePath();
				
						context.lineWidth = 1;
						context.strokeStyle = "white";
						context.fillStyle = "white";
						context.fill();
						context.stroke();
						
						placeCannon(context);

					});
					
					shapesLayer.draw();
					shapesLayer.add(groundLine[0]);
				})();
				
				stage.add(shapesLayer);
			}
		</script>
	</head>
<body bgcolor="black">// onmousedown="return false;">
		<table border="0" align="center">
			   <tr>
				<td colspan="3">
					<p align="center">
						<font size="5" face="arial" color="aliceblue">
							Ballistica
						</font>
					</p>
				</td>
			</tr>	        
			<tr>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							<span id="moves">Angle: 90&deg;</span>
						</font>
					</p>
				</td>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							<span id="score">Force: 50%</span>
						</font>
					</p>
				</td>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							<span id="score">Wind: 0mph West</span>
						</font>
					</p>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<div id="container"></div>
				</td>
			</tr>	        
			<tr>
				<td colspan="3">
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							<span id="settings">
								<button onclick="NewGame();">Start!</button>
							</span>
						</font>
					</p>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<p align="right">
						<font size="2" face="arial" color="aliceblue" >
							//GM &copy; 2012
						</font>
					</p>
				</td>
			</tr>	
		</table>	
	</body>
</html>
