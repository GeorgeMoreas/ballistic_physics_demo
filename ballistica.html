<html>
	<head>
		<script src=https://teikn-js.googlecode.com/svn-history/r23/trunk/libraries/kinetic-v3.6.0.js></script>
		<script>
			//drawing layer for shapes, needs to be added to stage to get rendered
			//var shapesLayer = new Kinetic.Layer();
			var groundLine = [];
			var gameWidth = 300;
			var gameHeight = 300;
			var groundCoords = [gameWidth];
			var cannonX = 20;
			var canvas;
			var context;
			var angle = 45;
			var power = 100;
			var damage = 50;
			var globX = cannonX;			
			var globY;
			var firstShot = true;
			var myCircle = {
				x: 0,
				y: 0,
				radius: 2,
				borderWidth: 1
			};
			var requestAnimationFrame =  
				window.requestAnimationFrame ||
				window.webkitRequestAnimationFrame ||
				window.mozRequestAnimationFrame ||
				window.msRequestAnimationFrame ||
				window.oRequestAnimationFrame ||
				function(callback) {
				  return setTimeout(callback, 1000);
				};
			
			function calcDistance(vel, ang, gra) {
				var dis = (Math.pow(vel, 2) * Math.sin(2 * ang)) / g;
				return dis;
			}
			
			function calcTimeOfFlight(vel, ang, gra, dis) {
				var tim = dis / (vel * Math.cos(ang));
				return tim;
			}
			
			function heightAtX(origY, x, ang, gra, vel) {
				var y = origY + (x * Math.tan(ang)) - ((gra * Math.pow(x, 2)) / (2 * Math.pow(vel * Math.cos(ang), 2)));
				return y;
			}
			
			function velocityAtX(vel, gra, x, ang) {
				var vel = Math.sqrt(Math.pow(vel, 2) - (2 * gra * x * Math.tan(ang)) + Math.pow((gra * x) / (vel * Math.cos(ang)), 2));
				return vel;
			}
			
			function toDegrees (angle) {
			  return angle * (180 / Math.PI);
			}

			function toRadians (angle) {
			  return angle * (Math.PI / 180);
			}
			
			function noCollision(y, groundY) {
				if (y < groundY) {
					return true;
				}
				return false;
			}
			
			function drawCircle(myCircle, myColor) {
				context.beginPath();
				context.arc(myCircle.x, myCircle.y, myCircle.radius, 0, 2 * Math.PI, false);
				context.fillStyle = myColor;
				context.fill();
				context.lineWidth = myCircle.borderWidth;
				context.strokeStyle = myColor;
				context.stroke();
			}
			
			var animate = function() {
				var circleColor;
						
				globX++;
				globY = groundCoords[cannonX] - heightAtX(0, globX, toRadians(angle), 10, power);
				
				context.clearRect(myCircle.x - myCircle.radius - 1, myCircle.y - myCircle.radius - 1, myCircle.radius * 2 + 2, myCircle.radius * 2 + 2);
						
				myCircle.x = globX;		
				myCircle.y = globY;
				
				var redValue = 355 - globX;
				var blueValue = globX;
				
				if (noCollision(globY, groundCoords[globX])) {
					circleColor = "rgb(" + 255 + ", 0, " + blueValue + ")";
					drawCircle(myCircle, circleColor);
					window.requestAnimationFrame(animate);
				} else {
					myCircle.radius = 25;
					circleColor = 'black';
					drawCircle(myCircle, circleColor);
				}
			}
			
			function shoot() {
				if (firstShot) {
					NewGame();
					firstShot = false;
				}
			
				globX = cannonX;
				myCircle.radius = 2;
				angle = document.getElementById("angle").value;
				power = document.getElementById("power").value;
				wind = document.getElementById("wind").value;
				
				for (x = 0; x < gameWidth; x++) {
					for (y = gameHeight - 1; y >= 0; y--) {
						var pxl = context.getImageData(x, y, 1, 1).data;
						if (pxl[0] == 0 && pxl[1] == 0 && pxl[2] == 0) {
							groundCoords[x] = y + 2;
							break;
						}
					}
				}
				
				context.beginPath();
				context.moveTo(0, gameHeight);
				for (gx = 0; gx <= gameWidth; gx++) {
					context.lineTo(gx, groundCoords[gx]);
				}
				context.lineTo(gameWidth, gameHeight);
				context.closePath();				
				context.lineWidth = 1;
				context.strokeStyle = "white";
				context.fillStyle = "white";
				context.fill();
				context.stroke();
				
				animate();
			}
			
			function NewGame() {
				var stage = new Kinetic.Stage("container", gameWidth, gameHeight);
				var e = document.getElementById("container");
				
				e.style.width = gameWidth;
				e.style.height = gameHeight;
				
				canvas = document.getElementById('canvas');
				context = canvas.getContext('2d');

				var groundSumY = 0;
				var groundAvgY = 0
		
			  	//context.globalCompositeOperation = 'destination-over';
		
				for (a = 20; a < 100; a += 20) {
					context.beginPath();
					context.moveTo(0, gameHeight);
					for (x = 0; x <= gameWidth; x += a) {
						var y = 200 + Math.floor(Math.random() * 90);
						context.lineTo(x, y);
					}
					context.lineTo(gameWidth, gameHeight);
					context.closePath();

					context.lineWidth = 1;
					context.strokeStyle = "gray";
					context.fillStyle = "gray";
					context.fill();
					context.stroke();
				}
				for (x = 0; x < gameWidth; x++) {
					for (y = gameHeight - 1; y >= 0; y--) {
						var pxl = context.getImageData(x, y, 1, 1).data;
						if (pxl[3] == 0) {
							groundCoords[x] = y;
							groundSumY += y;
							break;
						}
					}
				}
				groundAvgY = groundSumY / gameWidth;
		
				for (x = 0; x <= gameWidth; x++) {
					groundCoords[x] = groundAvgY + (groundCoords[x] - groundAvgY) * (groundCoords[x] / (3 * groundAvgY));
				}
				
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				
				context.beginPath();
				context.rect(cannonX, groundCoords[cannonX] - 5, 10, 10);
				context.fillStyle = 'green';
				context.fill();
				context.closePath();
				context.lineWidth = 1;
				context.strokeStyle = 'green';
				context.stroke();
				
				context.beginPath();
				context.moveTo(0, gameHeight);
				for (gx = 0; gx <= gameWidth; gx++) {
					context.lineTo(gx, groundCoords[gx]);
				}
				context.lineTo(gameWidth, gameHeight);
				context.closePath();				
				context.lineWidth = 1;
				context.strokeStyle = "white";
				context.fillStyle = "white";
				context.fill();
				context.stroke();
				
				

			}
		</script>
	</head>
<body bgcolor="black">// onmousedown="return false;">
		<table border="0" align="center">
			   <tr>
				<td colspan="3">
					<p align="center">
						<font size="5" face="arial" color="aliceblue">
							Ballistica
						</font>
					</p>
				</td>
			</tr>	        
			<tr>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							Angle: <input type="text" id="angle" value="45" name="angle" size="3">&deg;
						</font>
					</p>
				</td>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							Force: <input type="text" id="power" value="100" name="force" size="3">%
						</font>
					</p>
				</td>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							Wind: <input type="text" id="wind" value="0" name="wind" size="3">mph
						</font>
					</p>
				</td>
				<td>
					<p align="center">
						<font size="2" face="arial" color="aliceblue">
							<button onclick="shoot();">Shoot!</button>
						</font>
					</p>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<div id="container">
						<canvas id="canvas" height="300" width="300">
					</div>
				</td>
			</tr>	 
			<tr>
				<td colspan="3">
					<p align="right">
						<font size="2" face="arial" color="aliceblue" >
							//GM &copy; 2015
						</font>
					</p>
				</td>
			</tr>	
		</table>	
	</body>
</html>
